# Первичная настройка дистрибутива после копирования

Вы скопировали содержимое снимка себе на компьютер. Сейчас же необходимо настроить дистрибутив для корректной работы на нём. Без выполнения этих действий Calmira GNU/Linux не будет работать.

## Смена корня

Первым делом необходимо загрузиться в только что скопированную Calmira. Сейчас же нельзя это сделать, так как система не загрузится - нужно настроить fstab и загрузчик. Поэтому на хост-системе произведём операцию смены корня.

> Первым делом вы должны смонтировать раздел жёсткого диска или образ виртуального диска qcow2 в вашу систему. Точка монтирования: `/mnt/calmira_system`. О монтировании сказано в инструкциях по копированию системы на раздел жёсткого диска ([здесь](install_sys.md)), либо в виртуальную машину ([здесь](install_qemu.md)).

```bash
for DIR in "dev" "dev/pts" "proc" "sys"; do
	sudo mount -v --bind /$DIR /mnt/calmira_system/$DIR
done

if [ -h /mnt/calmira_system/dev/shm ]; then
  mkdir -pv /mnt/calmira_system/$(readlink /mnt/calmira_system/dev/shm)
fi

chroot "/mnt/calmira_system" /usr/bin/env -i \
    HOME=/root TERM="$TERM"             \
    PS1='(chroot) \u:\w\$ '             \
    PATH=/bin:/sbin:/usr/bin:/usr/sbin  \
    /bin/bash --login
```

Вы окажетесь в скопированной Calmira GNU/Linux. Вы изолированы от хост-системы, и можете настраивать дистрибутив так, как вам удобно.

## Настройка file system table

`fstab` (file systems table) — один из конфигурационных файлов, который содержит информацию о различных файловых системах и устройствах хранения информации компьютера, описывает, как диск будет использоваться или как будет интегрирован в систему. Файл `/etc/fstab` делает возможным автоматическое монтирование определенных файловых систем, что особенно нужно при загрузке системы. Он содержит ряд строк, описывающих файловые системы, их точки монтирования и другие параметры.

Каждая строка содержит:

* устройство монтируемой файловой системы;
* точку монтирования;
* тип файловой системы;
* параметры монтирования;
* флаг для dump, утилиты создания резервных копий;
* порядок проверки для `fsck` (File System ChecK).

Здесь всегда есть запись о корневой файловой системе. Раздел swap является специальным, поэтому его не видно в древовидной структуре, и в поле точки монтирования для таких разделов всегда содержится ключевое слово swap.

Необходимо настроить fstab, чтобы система корректно загружалась. Настройка fstab будет примерно одинаковой как для способа установки системы на раздел жёсткого диска, так и для способа установки системы в виртуальную машину Qemu.

### Настройка fstab

Создайте файл fstab:
```bash
cat > /etc/fstab << "EOF"
# Begin /etc/fstab

# file system  mount-point  type     options             dump  fsck order

/dev/sdX       /            ext4     defaults            1     1
proc           /proc        proc     nosuid,noexec,nodev 0     0
sysfs          /sys         sysfs    nosuid,noexec,nodev 0     0
devpts         /dev/pts     devpts   gid=5,mode=620      0     0
tmpfs          /run         tmpfs    defaults            0     0
devtmpfs       /dev         devtmpfs mode=0755,nosuid    0     0
EOF
```

Замените `/dev/sdX` из первой строки `fstab` на метку корневого раздела, на который устанавливалась система. Например, `/dev/sda3`. Если вы устанавливаете систему в виртуальную машину, то метка корневого раздела будет называться примерно так: `/dev/nbd0pX`, где `X` - номер нужного раздела.

Если у вас UEFI, то добавьте соотв. запись в fstab:

```bash
echo "/dev/sdN     /boot/efi      vfat    umask=0077           0     0" >> /etc/fstab
```

Замените `/dev/sdN` из команды выше на нужную метку раздела EFI. Повторимся, что его объём жолжен быть равен 256 Мб, файловая система - Fat32 (vfat).

Если вы используете `swap`-раздел, то и его пропишите в `fstab`:

```bash
echo "/dev/sdM     swap         swap     pri=1               0     0" >> /etc/fstab
```

Замените `/dev/sdM` из команды выше на нужную метку раздела с подкачкой (swap).

### Монтировать в ОЗУ или не монтировать? - вот в чём вопрос.

Как вы могли заметить в `/etc/fstab`, некоторые директории монтируются в оперативную память (посредством `tmpfs`). У такого способа главное достоинство в том, что при монтировании этих каталогов в tmpfs, система будет работать несколько быстрее. На современном оборудовании это не так заметно, но на старом и слабом может сделать систему немного быстрее.

Недостаток в том, что на несколько Мб система будет потреблять больше. Так, например, если система потребляла 28 Мб, то с монтированием в tmpfs будет потреблять 30 Мб. Потребление зависит от содержимого тех директорий.

Владельцам оборудования с небольшим объёмом ОЗУ (меньше 64 мегабайт) просьба учитывать этот факт и трезво оценить достоинства и недостатки выноса некоторых директорий в ОЗУ.

### Дополнительно о метке корневого раздела с системой

Мы настоятельно советуем использовать вместо метки корневого раздела, на который установлена Calmira GNU/Linux (например, `/dev/sda1`, `/dev/hdc2`, etc.), его UUID. Если метка диска, прописанного в `/etc/fstab` изменится, то могут возникнуть проблемы с загрузкой ОС, либо же она не загрузится вообще.

Узнать UUID для нужного раздела можно, выполнив:

```bash
blkid /dev/sdX
```

Замените `/dev/sdX` на метку корневого раздела. Например, `/dev/sda3`.

Вывод будет примерно таким:

```
/dev/sda3: UUID="1ed63fa7-e4c9-43cc-96f4-9f951224a338" BLOCK_SIZE="4096" TYPE="ext4" PARTLABEL="Calmira data" PARTUUID="56ae06ac-dbd8-11eb-96fc-e8039ae29c93"
```

Вам понадобится что-то вроде:

```
UUID="1ed63fa7-e4c9-43cc-96f4-9f951224a338"
```

Запишите эту строку вместо `/dev/sdX` в fstab (но без кавычек). Напимер, fstab с UUID корневого раздела вместо его метки будет выглядеть так:

```bash
cat > /etc/fstab << "EOF"
# Begin /etc/fstab

# file system  mount-point  type     options             dump  fsck order

UUID=1ed63fa7-e4c9-43cc-96f4-9f951224a338      /            ext4     defaults            1     1
proc           /proc        proc     nosuid,noexec,nodev 0     0
sysfs          /sys         sysfs    nosuid,noexec,nodev 0     0
devpts         /dev/pts     devpts   gid=5,mode=620      0     0
tmpfs          /run         tmpfs    defaults            0     0
devtmpfs       /dev         devtmpfs mode=0755,nosuid    0     0
EOF
```

Замените `UUID=1ed63fa7-e4c9-43cc-96f4-9f951224a338` на полученное значение.

Этот способ является более надёжным, чем использование обычных меток дисков/разделов, которые могут в определённых ситуациях меняться.

## Установка загрузчика GRUB

В Calmira используется классический загрузчик GRUB2. Без него система не сможет загрузиться. Процесс установки для MBR BIOS, Legacy BIOS/GPT BIOS, UEFI различаются. Здесь будут описаны все эти три случая.

### Установка загрузчика в MBR

Для того, чтобы установить загрузчик, выполните:

```bash
grub-install /dev/sdX
```

Замените `sdX` на метку диска. Например, `/dev/sda` или `/dev/nbd0`.

> **ЗАМЕЧАНИЕ**. В предыдущих инструкциях нужно было заменить `sdX` на метку раздела (например, на `sda3`). Сейчас же нужно заменить на метку ДИСКА (например, `sda`). Полученная команда будет `grub-install /dev/sda`, если вы выбрали установку загрузчика на этот диск. НЕ ВЫБИРАЙТЕ установку в раздел (`sda3`) - ни к чему это не приведёт.

### Установка загрузчика Legecy BIOS

Если вы по каким-то причинам используете Legacy BIOS, либо же обычный BIOS, но у жёсткого диска таблица разделов GPT, то для установки загрузчика вам необходимо иметь раздел объёмом 1 Мб без файловой системы в начале диска. Если у вас на ПК уже установлена какая-либо ОС, то этот раздел должен присутствовать.

Установите загрузчик командой:

```bash
grub-install /dev/sdX
```

Замените `sdX` на метку диска. Например, `/dev/sda` или `/dev/nbd0`.

> **ЗАМЕЧАНИЕ**. В предыдущих инструкциях нужно было заменить `sdX` на метку раздела (например, на `sda3`). Сейчас же нужно заменить на метку ДИСКА (например, `sda`). Полученная команда будет `grub-install /dev/sda`, если вы выбрали установку загрузчика на этот диск `/dev/sda`. НЕ ВЫБИРАЙТЕ установку в раздел (`sda3`) - ни к чему это не приведёт.

### Установка загрузчика EFI

На данный момент все современные ПК имеют UEFI, а не BIOS. Для установки системы на UEFI, вы должны иметь доп. раздел объёмом 256 Мб с файловой системой `fat32` и названием `ESP`. Если у вас на ПК уже установлена какая-либо ОС, то этот раздел уже имеется. Смонтируйте его в `/boot/efi` командой `mount`. После чего необходимо установить несколько пакетов из системы портов для правильной работы загрузчика.

Установите из все порты из `base/grub-efi` в следующем порядке:
* `efivar`;
* `popt` (находится не в `base/grub-efi`, а в `general_libs`);
* `efibootmgr`;
* `grub`

Для этого выполнить:

```bash
cd /usr/ports/$КАТЕГОРИЯ/$ПАКЕТ
./install
```

`$КАТЕГОРИЯ` - категория, в котором располагается порт. Например, `base/grub-efi` или `general_libs`

`$ПАКЕТ` - имя нужного пакета. Например, `efibootmgr`.

После чего можно устанавливать grub:

```bash
grub-install /dev/sdX
```

Замените `sdX` на метку диска. Например, `/dev/sda` или `/dev/nbd0`.

> **ЗАМЕЧАНИЕ**. В предыдущих инструкциях нужно было заменить `sdX` на метку раздела (например, на `sda3`). Сейчас же нужно заменить на метку ДИСКА (например, `sda`). Полученная команда будет `grub-install /dev/sda`, если вы выбрали установку загрузчика на этот диск. НЕ ВЫБИРАЙТЕ установку в раздел (`sda3`) - ни к чему это не приведёт.

## Создание конфига GRUB (актуально для установки загрузчика на MBR или Legacy BIOS)

Создайте конфиг следующей командой:

```bash
cat > /boot/grub/grub.cfg << "EOF"
# Begin /boot/grub/grub.cfg
set default=0
set timeout=5

insmod ext2
set root=(hd0,2)

menuentry "Calmira LX4 1.1 GNU/Linux, Linux" {
        linux /boot/vmlinuz root=/dev/sda2 ro
}
EOF
```

Строка `set timeout=5` устанавливает таймаут (время ожидания автоматической загрузки системы, если пользователь не выбрал ни одного элемента из загрузочного меню GRUB), равный пяти секундам. Измените это значение при необходимости.

Строка `set root=(hd0,2)` устанавливает нужный жёсткий диск. Если вы не знаете какой выбрать, наберите в консоли GRUB строки:

```bash
ls

ls ($DISK)/boot/grub
```

Первая команда выдаст список дисков, а вторая выдаст список файлов загрузчика, если выбран нужный диск с системой (замените `$DISK` на нужный диск из вывода первой команды).

Строка `linux /boot/vmlinuz root=/dev/sda2 ro` указывает нахождение ядра Linux (`linux /boot/vmlinuz`) и его нахождение на определённом разделе (`root=/dev/sda2`). Замените `/dev/sda2` на ваш корневой раздел, куда копировалась система в предыдущей инструкции.

***

[Назад - Установка системы в Qemu/KVM (алтернативный вариант установки системы, но не на реальное железо, а в виртуальную машину)](install_qemu.md)

[Далее - Завершение установки. Выход из chroot и перезагрузка](exit.md)
